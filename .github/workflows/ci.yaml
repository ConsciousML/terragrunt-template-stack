name: CI

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Prevent CI to run concurrently
concurrency:
  group: ci-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  CI:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2.2.3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.1'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        uses: pre-commit/action@v3.0.1

      - name: Run Terragrunt stack generate and plan
        run: |
          cd examples/stacks/foo-bar-local
          terragrunt stack generate
          terragrunt stack run plan
      
      - name: Check for 'run-terratest' label
        id: label_check
        uses: actions-ecosystem/action-has-label@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          label: run-terratest   # <--- this is the label name

       # Fail if label is missing
      - name: Fail if 'run-terratest' label is missing
        if: steps.label_check.outputs.has_label != 'true'
        run: |
          echo "ERROR: Missing 'run-terratest' label. Please add this label to run infra tests."
          exit 1

      # Run Terratest only if label present
      - name: Run Terratest
        if: steps.label_check.outputs.has_label == 'true'
        run: go test -v ./tests/... -timeout 30m
